services:
  elasticsearch:
    image: elasticsearch:8.15.4
    container_name: es-local
    environment:
      - node.name=es-node-1
      - cluster.name=es-docker-cluster
      - discovery.type=single-node
      - xpack.security.enabled=false # 本地开发禁用安全校验
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m" # 限制内存，防止吃光宿主机资源
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - es_data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    # 核心逻辑：启动前检查并安装 IK 插件，然后启动 ES
    command: >
      bash -c "
        if [ ! -d 'plugins/analysis-ik' ]; then
          # 加上 --batch 避免安装时的交互确认导致进程卡死
          # 使用你找到的高效地址
          bin/elasticsearch-plugin install --batch https://get.infini.cloud/elasticsearch/analysis-ik/8.15.4
        fi;
        # 确保使用绝对路径启动 ES
        exec /usr/local/bin/docker-entrypoint.sh elasticsearch
      "

volumes:
  es_data: