name: wknetic
services:
  # -----------------------------------------------------------------------------
  # MySQL æ•°æ®åº“
  # -----------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: wknetic-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASS:-123456789} # è¯»å–ç¯å¢ƒå˜é‡æˆ–ä½¿ç”¨é»˜è®¤å€¼
      MYSQL_DATABASE: wknetic
      TZ: Asia/Shanghai
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --default-authentication-plugin=mysql_native_password
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./sql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - wknetic-net

  # -----------------------------------------------------------------------------
  # Redis ç¼“å­˜
  # -----------------------------------------------------------------------------
  redis:
    image: redis:latest
    container_name: wknetic-redis
    restart: always
    command: redis-server --appendonly yes --requirepass "${REDIS_PASSWORD:-wknetic_secure_pass}"
    volumes:
      - ./data/redis:/data
    networks:
      - wknetic-net
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-wknetic_secure_pass}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # -----------------------------------------------------------------------------
  # Elasticsearch æœç´¢å¼•æ“
  # -----------------------------------------------------------------------------
  elasticsearch:
    image: elasticsearch:8.15.4
    container_name: wknetic-es
    environment:
      - discovery.type=single-node
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m" # é™åˆ¶å†…å­˜ï¼Œé˜²æ­¢æœåŠ¡å™¨å¡æ­»
      - TZ=Asia/Shanghai
      - xpack.security.enabled=false
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./data/es/data:/usr/share/elasticsearch/data
      - ./data/es/plugins:/usr/share/elasticsearch/plugins
    ports:
      - "9200:9200"
    networks:
      - wknetic-net
    # æ ¸å¿ƒé€»è¾‘ï¼šå¯åŠ¨å‰æ£€æŸ¥å¹¶å®‰è£… IK æ’ä»¶ï¼Œç„¶åå¯åŠ¨ ES
    command: >
      bash -c "
        if [ ! -d 'plugins/analysis-ik' ]; then
          # åŠ ä¸Š --batch é¿å…å®‰è£…æ—¶çš„äº¤äº’ç¡®è®¤å¯¼è‡´è¿›ç¨‹å¡æ­»
          # ä½¿ç”¨ä½ æ‰¾åˆ°çš„é«˜æ•ˆåœ°å€
          bin/elasticsearch-plugin install --batch https://get.infini.cloud/elasticsearch/analysis-ik/8.15.4
        fi;
        # ç¡®ä¿ä½¿ç”¨ç»å¯¹è·¯å¾„å¯åŠ¨ ES
        exec /usr/local/bin/docker-entrypoint.sh elasticsearch
      "
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:9200 || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10


  # -----------------------------------------------------------------------------
  # åç«¯æœåŠ¡ (Spring Boot)
  # -----------------------------------------------------------------------------
  backend:
    image: wekyjay/wknetic-server:0.0.1 
    container_name: wknetic-backend
    restart: always
    depends_on:
      redis:
        condition: service_healthy
      mysql:
        condition: service_started
      elasticsearch:
        condition: service_healthy
    
    ports:
      - "8081:8081" # æ¸¸æˆé€šä¿¡ Netty ç«¯å£
    volumes:
      - ./data/uploads:/app/uploads # æ–‡ä»¶ä¸Šä¼ æŒä¹…åŒ–
      - ./logs:/app/logs # æ—¥å¿—æŒä¹…åŒ–
    environment:
      # --- æ ¸å¿ƒç¯å¢ƒé…ç½® ---
      SPRING_PROFILES_ACTIVE: prod
      TZ: Asia/Shanghai
      
      # --- æ•°æ®åº“è¿æ¥ (host æ”¹ä¸º mysql) ---
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/wknetic?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASS:-123456789}

      # --- Redis è¿æ¥ (host æ”¹ä¸º redis) ---
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD:-wknetic_secure_pass}
      SPRING_DATA_REDIS_DATABASE: 0

      # --- ES è¿æ¥ (host æ”¹ä¸º elasticsearch) ---
      SPRING_ELASTICSEARCH_URIS: http://elasticsearch:9200
      SPRING_ELASTICSEARCH_CONNECTION_TIMEOUT: 5s
      
      # --- JWT å¯†é’¥ ---
      WKNETIC_JWT_SECRET: "WkNeticCoreSecretKeyForSpringSecurityVersion2026MakeItLong"
      
      # --- æ–‡ä»¶ä¸Šä¼ è·¯å¾„ ---
      STORAGE_LOCAL_BASE_PATH: /app/uploads
      STORAGE_LOCAL_BASE_URL: http://localhost:${WEB_PORT:-80}/uploads
    networks:
      - wknetic-net

  # -----------------------------------------------------------------------------
  # å‰ç«¯æœåŠ¡ (Nginx)
  # -----------------------------------------------------------------------------
  frontend:
    # ğŸ‘‡ è®°å¾—æ”¹æˆä½ è‡ªå·± Docker Hub çš„ç”¨æˆ·å
    image: wekyjay/wknetic-ui:0.0.1 
    container_name: wknetic-frontend
    restart: always
    ports:
      - "${WEB_PORT:-80}:80" # æ˜ å°„ 80 ç«¯å£åˆ°å®¿ä¸»æœº
    depends_on:
      - backend
    networks:
      - wknetic-net

# ç½‘ç»œå®šä¹‰
networks:
  wknetic-net:
    driver: bridge